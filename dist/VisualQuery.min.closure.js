!function(m){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=m();else if("function"==typeof define&&define.amd)define([],m);else{var d;"undefined"!=typeof window?d=window:"undefined"!=typeof global?d=global:"undefined"!=typeof self&&(d=self);d.VisualQuery=m()}}(function(){return function d(g,k,b){function c(a,l){if(!k[a]){if(!g[a]){var h="function"==typeof require&&require;if(!l&&h)return h(a,!0);if(f)return f(a,!0);h=Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",
h;}h=k[a]={exports:{}};g[a][0].call(h.exports,function(h){var f=g[a][1][h];return c(f?f:h)},h,h.exports,d,g,k,b)}return k[a].exports}for(var f="function"==typeof require&&require,a=0;a<b.length;a++)c(b[a]);return c}({1:[function(d,g,k){g.exports=function(){function b(a,b){c.apply(this);this.type="text";this.name=a;this.$=f("input",{type:"text",spellcheck:"false",autoComplete:"off","class":a}).css("width","1px");"string"===typeof b&&(this.$._.value=b);this.bindEvents()}var c=d("EventEmitter"),f=d("Element"),
a=d("./inputResize");b.prototype=Object.create(c.prototype);b.prototype.lean=function(){return this.$._.value||""};b.prototype.previewValue=function(a){this.$.attr("placeholder",a).trigger("input")};b.prototype.focus=function(a){this.$.focus(a)};b.prototype.changeValue=function(a){a&&(this.$._.value=a);this.$.trigger("input").trigger("blur").trigger("change");this.emit("nextInput")};b.prototype.bindEvents=function(){var c=this;this.on("rendered",function(){c.$.trigger("input")});this.$.on("focus",
function(){c.emit("focus")}).on("blur",function(){c.emit("blur")}).on("change",function(){c.emit("change")}).on("keydown",function(a){0===this.selectionStart&&0===this.selectionEnd&&(37===a.keyCode||0===this.value.length&&8===a.keyCode)&&(a.preventDefault(),c.emit("prevInput"));this.value.length===this.selectionStart&&this.value.length===this.selectionEnd&&39===a.keyCode&&(a.preventDefault(),c.emit("nextInput"))}).on("input",a)};b.prototype.validate=function(){var a=this.$._.value;return"number"!==
this.type||a.match(/^\d+$/)?"time"!==this.type||a.match(/^\d{1,2}:\d{2} (?:AM|PM)$/)?!0:"Not a valid time format":"Not a number"};return b}()},{"./inputResize":6,Element:7,EventEmitter:8}],2:[function(d,g,k){g.exports=function(){function b(c,f,b){e.apply(this);this.autocomplete=f;this.schema=b;c=c||{};this.name=new l("name",c.name);this.operator=new l("operator",c.operator);this.value=new l("value",c.value);this.$=a("div",{"class":"parameter"}).append(a("span",{"class":"remove",html:"&times;"}).on("click",
this.emit.bind(this,"remove")),this.name.$,this.operator.$,this.value.$);this.validateInputs();this.bindEvents()}function c(a){return function(c){a.previewValue(c)}}function f(a){return function(c){a.changeValue(c)}}var a=d("Element"),e=d("EventEmitter"),l=d("./Input");b.prototype=Object.create(e.prototype);b.prototype.lean=function(){return{name:this.name.lean(),operator:this.operator.lean(),value:this.value.lean(),invalid:this.invalid}};b.prototype.bindEvents=function(){var a=this;this.on("rendered",
function(){a.name.emit("rendered");a.operator.emit("rendered");a.value.emit("rendered")});[this.name,this.operator,this.value].forEach(function(c){c.on("focus",function(){a.emit("focus");a.$.removeClass("error").addClass("selected")}).on("blur",function(){a.emit("blur");a.$.removeClass("selected");a.validateInputs()}).on("change",function(){a.emit("change")})});this.bindName();this.bindOperator();this.bindValue()};b.prototype.bindName=function(){var a=this;this.name.on("nextInput",function(){a.operator.focus(0)}).on("prevInput",
function(){a.emit("prevParameter")}).on("focus",function(){a.autocomplete.bindTo(a.name.$,a.schema.names).on("hover",c(a.name)).on("selected",f(a.name))})};b.prototype.bindOperator=function(){var a=this;this.operator.on("nextInput",function(){a.value.focus(0)}).on("prevInput",function(){a.name.focus(-0)}).on("focus",function(){var b=a.schema._[a.name.$._.value];a.autocomplete.bindTo(a.operator.$,b instanceof Object&&b.operators instanceof Object&&b.operators).on("hover",c(a.operator)).on("selected",
f(a.operator))})};b.prototype.bindValue=function(){var a=this;this.value.on("nextInput",function(){a.emit("nextParameter")}).on("prevInput",function(){a.operator.focus(-0)}).on("focus",function(){var b=a.schema._[a.name.$._.value];a.autocomplete.bindTo(a.value.$,b instanceof Object&&b.values instanceof Object&&b.values).on("hover",c(a.value)).on("selected",f(a.value));b instanceof Object&&("string"===typeof b.type&&(a.value.type=b.type),b.valueAttrs instanceof Object&&"string"===typeof b.valueAttrs.placeholder&&
a.value.previewValue(b.valueAttrs.placeholder))})};b.prototype.validateInputs=function(){var a=this.name.$._.value,c=this.operator.$._.value,b=this.value.$._.value;if((a+c+b).length)if(a.length&&c.length&&b.length){if(this.schema.strict){if(!this.schema._.hasOwnProperty(a)){this.$.addClass("error").attr("title",this.invalid="Invalid name");return}if(-1===this.schema._[a].operators.indexOf(c)){this.$.addClass("error").attr("title",this.invalid="Invalid operator");return}if(this.schema._[a].values instanceof
Array&&-1===this.schema._[a].values.indexOf(b)){this.$.addClass("error").attr("title",this.invalid="Invalid value");return}}if("string"===typeof(a=this.value.validate()))this.$.addClass("error").attr("title",a);else return this.invalid=!1}else this.$.addClass("error").attr("title",this.invalid="Incomplete parameter");else this.emit("remove")};return b}()},{"./Input":1,Element:7,EventEmitter:8}],3:[function(d,g,k){g.exports=function(){function b(a,b){var d=this;f.apply(d);Array.apply(d);d.schema={strict:!!b.strict,
names:Object.keys(b.schema),_:b.schema};d.$placeholder=c("div",{"class":"placeholder"}).css("pointerEvents","none").text(b.placeholder||"");d.$inputField=c("div",{"class":"parameters"}).append(d.$placeholder).on("mousedown",function(a){if(a.target===d.$inputField._){a.preventDefault();var c=0;d.some(function(b,f){var l=b.$._.getBoundingClientRect(),e=document.body.scrollTop+l.top;if(a.pageY<l.top||e<a.pageY&&a.pageY<e+l.height&&l.left>a.pageX)return!0;c=f+1});d.insertAt(c,d.newParameter(),!0)}});
d.autocomplete=new e(d.$inputField);b.defaultQuery.forEach(function(a){a instanceof Object&&d.insert(a)});d.appendTo(a);setTimeout(function(){d.emit("result",d.serialize())},0)}var c=d("Element"),f=d("EventEmitter"),a=d("./Parameter"),e=d("./autoComplete");b.prototype=Object.create(f.prototype);"length splice indexOf forEach map some".split(" ").forEach(function(a){b.prototype[a]=Array.prototype[a]});b.prototype.serialize=function(){return this.map(function(a){return a.lean()})};b.prototype.newParameter=
function(c){var b=this,f=new a(c,b.autocomplete,b.schema);return f.on("focus",function(){b.$inputField.addClass("selected");b.emit("focus")}).on("blur",function(){b.$inputField.removeClass("selected");b.emit("blur")}).on("remove",function(){b.remove(f);b.emit("result",b.serialize())}).on("change",function(){b.emit("result",b.serialize())}).on("prevParameter",function(a){(a=b.getPrev(f))?a.value.focus():b.insertAt(0,b.newParameter(),!0)}).on("nextParameter",function(a){(a=b.getNext(f))?a.name.focus(0):
b.insert()})};b.prototype.insertAt=function(a,c,b){this.$placeholder.hide();this[a]?this.$inputField._.insertBefore(c.$._,this[a].$._):this.$inputField.append(c.$);this.splice(a,0,c);b&&c.name.focus()};b.prototype.insert=function(a){this.insertAt(this.length,this.newParameter(a),!a)};b.prototype.removeAt=function(a){a=this.splice(a,1);1===a.length&&a[0].$.remove();0===this.length&&this.$placeholder.show()};b.prototype.remove=function(a,c){if(-1===(c=this.indexOf(a)))return!1;this.removeAt(c)};b.prototype.getPrev=
function(a,c){if(-1!==(c=this.indexOf(a)))return this[c-1]};b.prototype.getNext=function(a,c){if(-1!==(c=this.indexOf(a)))return this[c+1]};b.prototype.appendTo=function(a){c(a).append(this.$inputField);this.forEach(function(a){a.emit("rendered")})};return b}()},{"./Parameter":2,"./autoComplete":5,Element:7,EventEmitter:8}],4:[function(d,g,k){g.exports=function(b,c){var f;if("string"===typeof b)f=document.querySelector(b);else if("function"===typeof HTMLElement&&b instanceof HTMLElement||b instanceof
Object&&1===b.nodeType&&"string"===typeof b.nodeName)f=b;if(!f)throw Error("No element is selected");var a=Object.create({appendAutoCompleteTo:null,strict:!1,schema:{},defaultQuery:[],placeholder:""}),e;for(e in c)a[e]=c[e];return new (d("./Parameters"))(f,a)}},{"./Parameters":3}],5:[function(d,g,k){g.exports=function(){function b(b){this.$ul=c("ul",{"class":"autoComplete"}).css("position","absolute").hide();this.lis=[];this.selectedLi=null;(this.$parent=b).append(this.$ul).on("scroll",this.adjustLocation.bind(this));
var a=this;this.onKeydown=function(c){if(38===c.keyCode){var b;a.selectedLi&&a.selectedLi.shown()&&(b=a.selectedLi.prev())&&b.shown()&&(c.preventDefault(),a.selectLi(b))}if(40===c.keyCode)if(a.selectedLi&&a.selectedLi.shown()){var f;(f=a.selectedLi.next())&&f.shown()&&(c.preventDefault(),a.selectLi(f))}else for(b=0;b<a.lis.length;b++)if(a.lis[b].shown()){c.preventDefault();a.selectLi(a.lis[b]);break}13===c.keyCode&&(a.selectedLi&&a.selectedLi.shown()?a.EE.emit("selected",a.selectedLi.text(),a.selectedLi.attr("value")):
a.EE.emit("selected"))};this.onInput=function(){for(var c=0,b=0;b<a.lis.length;b++)a.lis[b].text().match(new RegExp(this.value,"i"))?a.lis[b].show():(a.lis[b].hide(),c++);c===a.lis.length?a.$ul.hide():a.$ul.show()};this.hide=function(){a.$ul.hide()}}var c=d("Element");b.prototype.adjustLocation=function(){var c=this.$parent._.getBoundingClientRect(),a=this.$input._.getBoundingClientRect();c.left<a.left&&a.left<c.left+c.width?(this.$ul.show().offset(0,0),c=this.$ul._.getBoundingClientRect(),this.$ul.offset(a.top-
c.top+a.height+"px",a.left-c.left+"px")):this.$ul.hide()};b.prototype.selectLi=function(b){this.selectedLi&&this.selectedLi.removeClass("selected");this.selectedLi=c(b).addClass("selected");this.EE.emit("hover",this.selectedLi.text());this.adjustLocation()};b.prototype.createLi=function(b,a){var e=this,d=c("li",{text:b}).on("mouseover",function(){e.selectLi(this)}).on("mousedown",function(a){a.preventDefault()}).on("mouseup",function(){e.selectedLi&&e.selectedLi.shown()&&e.EE.emit("selected",e.selectedLi.text(),
e.selectedLi.attr("value"))});a&&d.attr("value",a);return d};b.prototype.setList=function(c){this.lis.splice(0);if(c instanceof Array)for(var a in c)this.lis.push(this.createLi(c[a],!(c instanceof Array)&&a));this.$ul.html("").append(this.lis)};b.prototype.bindTo=function(c,a){this.$input&&(this.$input.off("keydown",this.onKeydown).off("input",this.onInput).off("blur",this.hide),this.EE=this.$input=null);this.EE=new (d("EventEmitter"));this.$input=c.on("keydown",this.onKeydown).on("input",this.onInput).on("blur",
this.hide);this.setList(a);this.adjustLocation();this.onInput.apply(c._);return this.EE};return b}()},{Element:7,EventEmitter:8}],6:[function(d,g,k){g.exports=function(){var b=this.value||this.attributes.placeholder&&this.attributes.placeholder.value||"",c=document.createElement("span");c.textContent=b;c.style.position="absolute";c.style.width="auto";c.style.visibility="hidden";c.style.whiteSpace="pre";var f=getComputedStyle(this);"fontSize fontFamily fontWeight fontStyle fontVariant wordSpacing letterSpacing textIndent textRendering textTransform".split(" ").forEach(function(a){c.style[a]=
f[a]});this.parentNode.appendChild(c);this.style.width=(c.offsetWidth||5)+1+"px";this.parentNode.removeChild(c)}},{}],7:[function(d,g,k){g.exports=function(){function b(c){this._=c}b.prototype.addClass=function(c){c=c.split(" ");for(var b=0;b<c.length;b++)c[b]&&(this._.classList?this._.classList.add(c[b]):this._.className=c[b]);return this};b.prototype.removeClass=function(c){this._.classList?this._.classList.remove(c):this._.className=this._.className.replace(new RegExp("(^|\\b)"+c.split(" ").join("|")+
"(\\b|$)","gi")," ");return this};b.prototype.hide=function(){"none"!==this._.style.display&&(this._.style.display="none");return this};b.prototype.show=function(){"block"!==this._.style.display&&(this._.style.display="block");return this};b.prototype.shown=function(){return this._===document||"none"!==this._.style.display&&null!==this._.parentNode};b.prototype.on=function(c,b,a){this._events instanceof Object||(this._events={});a=!!a;c=c.split(" ");for(var e=c.length;e--;){var d=c[e];this._events[d]instanceof
Array||(this._events[d]=[]);this._events[d].push(b);this._.addEventListener(d,b,a)}return this};b.prototype.off=function(c,b){this._events instanceof Object||(this._events={});c=c.split(" ");var a=c.length;if(b instanceof Function)for(;a--;){var e=c[a];if(this._events[e]instanceof Array){var d=this._events[e].indexOf(b);-1!==d&&this._events[e].splice(d,1);this._.removeEventListener(e,b)}}else for(;a--;)if(e=c[a],this._events[e]instanceof Array)for(;d=this._events[e].pop();)this._.removeEventListener(e,
d);return this};b.prototype.one=function(c,b){var a=this;return this.on(c,function l(){a.off(c,l);b.apply(this,[].slice.apply(arguments))})};b.prototype.append=function(c){for(var f=c instanceof Array?c:arguments,a=document.createDocumentFragment(),e=0,d=f.length;e<d;e++)a.appendChild(f[e]instanceof b?f[e]._:f[e]);this._.appendChild(a);return this};b.prototype.replaceWith=function(c){c=c instanceof b?c._:c;this._.parentNode&&this._.parentNode.replaceChild(c,this._);this._=c;return this};b.prototype.text=
function(c,b){var a=this.textWrap||this._;if(0===arguments.length)return a.textContent;a.textContent=(b?a.textContent:"")+c;return this};b.prototype.html=function(c,b){this._.innerHTML=(b?this._.innerHTML:"")+c;return this};b.prototype.attr=function(c,b){if("string"!==typeof c)throw Error("An attribute name is required");if(void 0===b)return this._.getAttribute(c);this._.setAttribute(c,b);return this};b.prototype.remove=function(){if(this._.parentNode)return this._.parentNode.removeChild(this._),
this};b.prototype.offset=function(c,b){this._.style.top=c;this._.style.left=b;return this};b.prototype.css=function(c,b){if("string"===typeof c)if("string"===typeof b)this._.style[c]=b;else return getComputedStyle(this._)[c];else if(c instanceof Object)for(var a in c)this._.style[a]=c[a];return this};b.prototype.trigger=function(b){b=new Event(b);this._.dispatchEvent(b);return this};b.prototype.focus=function(b,d){this._.focus();if("number"===typeof b){-Infinity===1/b&&(b=this._.value.length);"number"!==
typeof d&&(d=b);try{this._.setSelectionRange(b,d)}catch(a){}}return this};b.prototype.prev=function(){if(this._.previousSibling)return new b(this._.previousSibling)};b.prototype.next=function(){if(this._.nextSibling)return new b(this._.nextSibling)};b.prototype.data=function(b,d){this._data instanceof Object||(this._data={});if(void 0===d)return this._data[b];this._data[b]=d;return this};return function(c,d){if(c instanceof b)return c;var a=new b;if("string"===typeof c){if(a._=document.createElement(c),
"object"===typeof d){var e=Object.create(d);"string"===typeof e.textWrap&&(a.textWrap=document.createElement(e.textWrap),a._.appendChild(a.textWrap),e.textWrap=null);void 0!==e.text&&null!==d.text&&(a.text(e.text),e.text=null);"string"===typeof e.html&&(a.html(e.html),e.html=null);"string"===typeof e.class&&(a.addClass(e.class),e.class=null);for(var g in e)e[g]&&a._.setAttribute(g,e[g])}}else a._=c;return a}}()},{}],8:[function(d,g,k){g.exports=function(){function b(b){this._events={};this.async=
!!b}b.prototype.on=function(b,d){this._events instanceof Object||(this._events={});var a;(a=this._events[b])instanceof Array||(a=this._events[b]=[]);a.push(d);return this};b.prototype.off=function(b,d){this._events instanceof Object&&void 0!==b||(this._events={});var a,e;if(!((a=this._events[b])instanceof Array))return!1;void 0===d?a.splice(0):-1!==(e=a.indexOf(d))&&a.splice(e,1);return this};b.prototype.emit=function(b){this._events instanceof Object||(this._events={});if(!(this._events[b]instanceof
Array))return!1;for(var d=[].slice.apply(arguments,[1]),a=this._events[b],e,g=0,h=a.length;g<h;g++)(e=a[g])instanceof Function&&(!0===this.async?setTimeout(function(a,b,c){return function(){b.apply(a,c)}}(this,e,d),0):e.apply(this,d))};return b}()},{}]},{},[4])(4)});
