!function(r){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=r();else if("function"==typeof define&&define.amd)define([],r);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.VisualQuery=r()}}(function(){return function k(g,l,c){function a(e,b){if(!l[e]){if(!g[e]){var d="function"==typeof require&&require;if(!b&&d)return d(e,!0);if(f)return f(e,!0);d=Error("Cannot find module '"+e+"'");throw d.code="MODULE_NOT_FOUND",
d;}d=l[e]={exports:{}};g[e][0].call(d.exports,function(h){var b=g[e][1][h];return a(b?b:h)},d,d.exports,k,g,l,c)}return l[e].exports}for(var f="function"==typeof require&&require,d=0;d<c.length;d++)a(c[d]);return a}({1:[function(k,g,l){g.exports=function(){function c(d,b){a.apply(this);this.name=d;this.$=f("input",{type:"text",spellcheck:"false",autoComplete:"off","class":d}).css("width","1px");b&&(this.$._.value=b);this.bindEvents()}var a=k("EventEmitter"),f=k("Element"),d=k("./inputResize");c.prototype=
Object.create(a.prototype);c.prototype.toJSON=function(){return this.$._.value};c.prototype.previewValue=function(a){this.$.attr("placeholder",a).trigger("input")};c.prototype.focus=function(a){this.$._.disabled=!1;"number"===typeof a&&this.$._.setSelectionRange&&(-Infinity===1/a&&(a=this.$._.value.length),this.$._.setSelectionRange(a,a));this.$._.focus()};c.prototype.changeValue=function(a){a&&(this.$._.value=a);this.$.trigger("input").trigger("blur").trigger("change");this.emit("nextInput")};c.prototype.bindEvents=
function(){var a=this;this.on("rendered",function(){a.$.trigger("input")});this.$.on("focus",function(){a.emit("focus")}).on("blur",function(){a.emit("blur");a.$._.disabled=!0}).on("change",function(){a.emit("change")}).on("keydown",function(b){0===this.selectionStart&&0===this.selectionEnd&&(37===b.keyCode||0===this.value.length&&8===b.keyCode)&&(b.preventDefault(),a.emit("prevInput"));this.value.length===this.selectionStart&&this.value.length===this.selectionEnd&&39===b.keyCode&&(b.preventDefault(),
a.emit("nextInput"))}).on("input",d)};c.prototype.validate=function(){return 0===this.$._.value.length?!1:!0};return c}()},{"./inputResize":6,Element:7,EventEmitter:8}],2:[function(k,g,l){g.exports=function(){function c(a,b){e.apply(this);this.collection=a;b=b||{};this.name=new p("name",b.name);this.operator=new p("operator",b.operator);this.value=new p("value",b.value);this.$=d("div",{"class":"parameter"}).append(d("span",{"class":"remove",html:"&times;"}).on("click",this.emit.bind(this,"remove")),
this.name.$,this.operator.$,this.value.$);this.bindEvents()}function a(a){return function(b){a.previewValue(b)}}function f(a){return function(b){a.changeValue(b)}}var d=k("Element"),e=k("EventEmitter"),b=k("./autoComplete"),p=k("./Input");c.prototype=Object.create(e.prototype);c.prototype.toJSON=function(){return{name:this.name.toJSON(),operator:this.operator.toJSON(),value:this.value.toJSON()}};c.prototype.bindEvents=function(){var a=this;this.on("rendered",function(){a.name.emit("rendered");a.operator.emit("rendered");
a.value.emit("rendered")});[this.name,this.operator,this.value].forEach(function(b){b.on("focus",function(){a.emit("focus");a.$.removeClass("error").addClass("selected")}).on("blur",function(){a.emit("blur");a.$.removeClass("selected");a.validateInputs()}).on("change",function(){a.emit("change")})});this.bindName();this.bindOperator();this.bindValue();this.$.on("mousedown",function(b){b.preventDefault();if(!a.name.validate())return a.name.focus();if(!a.operator.validate())return a.operator.focus();
a.value.focus()})};c.prototype.bindName=function(){var h=this;this.name.on("nextInput",function(){h.operator.focus(0)}).on("prevInput",function(){h.emit("prevParameter")}).on("focus",function(){b(h.name.$,{appendTo:h.collection.$,datalist:h.collection.names}).on("hover",a(h.name)).on("selected",f(h.name))}).on("blur",function(){b(h.name.$)})};c.prototype.bindOperator=function(){var h=this;this.operator.on("nextInput",function(){h.value.focus(0)}).on("prevInput",function(){h.name.focus(-0)}).on("focus",
function(){b(h.operator.$,{appendTo:h.collection.$,datalist:h.collection.opts.schema[h.name.$._.value].operators}).on("hover",a(h.operator)).on("selected",f(h.operator))}).on("blur",function(){b(h.operator.$)})};c.prototype.bindValue=function(){var h=this;this.value.on("nextInput",function(){h.emit("nextParameter")}).on("prevInput",function(){h.operator.focus(-0)}).on("focus",function(){if("text"===h.value.$._.type)b(h.value.$,{appendTo:h.collection.$,datalist:h.collection.opts.schema[h.name.$._.value].values}).on("hover",
a(h.value)).on("selected",f(h.value))}).on("blur",function(){b(h.value.$)})};c.prototype.validateInputs=function(){var a=this.name.$._.value,b=this.operator.$._.value,d=this.value.$._.value;return(a+b+d).length?a.length&&b.length&&d.length?!0:(this.$.addClass("error"),!1):(this.emit("remove"),!1)};return c}()},{"./Input":1,"./autoComplete":5,Element:7,EventEmitter:8}],3:[function(k,g,l){g.exports=function(){function c(a){a.on("focus",function(){b.$.addClass("selected")}).on("blur",function(){b.$.removeClass("selected")}).on("remove",
function(){b.remove(a)}).on("change",function(){b.callback()}).on("prevParameter",function(d){(d=b.getPrev(a))?d.value.focus():b.insertAt(0,new f(b),!0)}).on("nextParameter",function(d){(d=b.getNext(a))?d.name.focus(0):b.insertAt(b.parameters.length,new f(b),!0)})}var a=k("Element"),f=k("./Parameter"),d=a("div",{"class":"placeholder"}).css("pointerEvents","none"),e=a("div",{"class":"parameters"}).append(d).on("mousedown",function(a){if(a.target===b.$._){a.preventDefault();var d=0;b.parameters.some(function(b,
c){var f=b.$._.getBoundingClientRect(),e=document.body.scrollTop+f.top;if(a.pageY<f.top||e<a.pageY&&a.pageY<e+f.height&&f.left>a.pageX)return!0;d=c+1});b.insertAt(d,new f(b),!0)}}),b={parameters:[]};b.$=e;b.init=function(a){this.opts=a;console.log(this.opts);d.text(a.placeholder||"");this.names=Object.keys(a.schema);this.opts.defaultQuery.forEach(function(a,d){b.insertAt(d,new f(b,a))});b.callback()};b.insertAt=function(a,b,f){d.hide();this.parameters[a]?e._.insertBefore(b.$._,this.parameters[a].$._):
this.$.append(b.$);this.parameters.splice(a,0,b);c(b);f&&b.name.focus()};b.removeAt=function(a){a=this.parameters.splice(a,1);1===a.length&&a[0].$.remove();0===this.parameters.length&&d.show();b.callback()};b.remove=function(a,b){if(-1===(b=this.parameters.indexOf(a)))return!1;this.removeAt(b)};b.getPrev=function(a,b){if(-1!==(b=this.parameters.indexOf(a)))return this.parameters[b-1]};b.getNext=function(a,b){if(-1!==(b=this.parameters.indexOf(a)))return this.parameters[b+1]};b.renderTo=function(b){a(b).append(this.$);
this.parameters.forEach(function(a){a.emit("rendered")})};b.callback=function(){b.opts.callback(b.parameters.map(function(a){return a.toJSON()}))};return b}()},{"./Parameter":2,Element:7}],4:[function(k,g,l){g.exports=function(c,a){var f;if("string"===typeof c)f=document.querySelector(c);else if("function"===typeof HTMLElement&&c instanceof HTMLElement||c instanceof Object&&1===c.nodeType&&"string"===typeof c.nodeName)f=c;if(!f)throw Error("No element is selected");var d=k("./Parameters"),e=Object.create({appendAutoCompleteTo:null,
strict:!1,schema:[],defaultQuery:[],placeholder:"",focusCallback:function(){},callback:function(){}}),b;for(b in a)e[b]=a[b];d.init(e);d.renderTo(f)}},{"./Parameters":3}],5:[function(k,g,l){g.exports=function(){function c(){var a=b._.getBoundingClientRect(),c=g._.getBoundingClientRect();a.left<c.left&&c.left<a.left+a.width?(d.show().offset(0,0),a=d._.getBoundingClientRect(),d.offset(c.top-a.top+c.height+"px",c.left-a.left+"px")):d.hide()}var a=k("Element"),f=k("EventEmitter"),d=a("ul",{"class":"autoComplete"}).css("position",
"absolute").hide(),e=function(){function b(d){m&&m.removeClass("selected");m=a(d).addClass("selected");p.emit("hover",m.text())}function c(){for(var a=0,b=0;b<n.length;b++)n[b]._.innerText.match(new RegExp(this.value,"i"))?n[b].show():(n[b].hide(),a++);a===n.length?d.hide():d.show()}function e(a){if(38===a.keyCode){var d;m&&m.shown()&&(d=m.prev())&&d.shown()&&(a.preventDefault(),b(d))}if(40===a.keyCode)if(m&&m.shown()){var c;(c=m.next())&&c.shown()&&(a.preventDefault(),b(c))}else for(d=0;d<n.length;d++)if(n[d].shown()){a.preventDefault();
b(n[d]);break}13===a.keyCode&&(m&&m.shown()?p.emit("selected",m.text(),m.attr("value")):p.emit("selected"))}function k(d,c){var f=a("li",{text:d}).on("mouseover",function(){b(this)}).on("mousedown",function(a){a.preventDefault()}).on("mouseup",function(){m&&m.shown()&&p.emit("selected",m.text(),m.attr("value"))});c&&f.attr("value",c);return f}var g=null,p=null,n=[],m=null;return{setDatalist:function(a){n.splice(0);for(var b in a)n.push(k(a[b],!(a instanceof Array)&&b));d.html("").append(n);return this},
listenTo:function(a){g&&(m=null,g.off("keydown",e).off("input",c));g=a;p=new f;g.on("keydown",e).on("input",c);c.apply(g._);return p}}}(),b,g;return function(a,f){if("INPUT"!==a._.tagName||"text"!==a.attr("type"))throw Error("Autocomplete must be bound to an input-text element");if(f instanceof Object){if(!f.appendTo)throw Error("The appendTo property is required to render the auto complete");g=a.on("input",c);(b=f.appendTo).append(d).on("scroll",c);c();return e.setDatalist(f.datalist).listenTo(a)}d.hide();
g.off("scroll",c);b.off("scroll",c)}}()},{Element:7,EventEmitter:8}],6:[function(k,g,l){g.exports=function(){var c=this.value||this.attributes.placeholder&&this.attributes.placeholder.value||"",a=document.createElement("span");a.textContent=c;a.style.position="absolute";a.style.width="auto";a.style.visibility="hidden";a.style.whiteSpace="pre";var f=getComputedStyle(this);"fontSize fontFamily fontWeight fontStyle fontVariant wordSpacing letterSpacing textIndent textRendering textTransform".split(" ").forEach(function(d){a.style[d]=
f[d]});this.parentNode.appendChild(a);this.style.width=(a.offsetWidth||5)+1+"px";this.parentNode.removeChild(a)}},{}],7:[function(k,g,l){g.exports=function(){function c(a){this._=a}c.prototype.addClass=function(a){a=a.split(" ");for(var c=0;c<a.length;c++)a[c]&&(this._.classList?this._.classList.add(a[c]):this._.className=a[c]);return this};c.prototype.removeClass=function(a){this._.classList?this._.classList.remove(a):this._.className=this._.className.replace(new RegExp("(^|\\b)"+a.split(" ").join("|")+
"(\\b|$)","gi")," ");return this};c.prototype.hide=function(){"none"!==this._.style.display&&(this._.style.display="none");return this};c.prototype.show=function(){"block"!==this._.style.display&&(this._.style.display="block");return this};c.prototype.shown=function(){return"none"!==this._.style.display};c.prototype.on=function(a,c,d){this._events instanceof Object||(this._events={});d=!!d;a=a.split(" ");for(var e=a.length;e--;){var b=a[e];this._events[b]instanceof Array||(this._events[b]=[]);this._events[b].push(c);
this._.addEventListener(b,c,d)}return this};c.prototype.off=function(a,c){this._events instanceof Object||(this._events={});a=a.split(" ");var d=a.length;if(c instanceof Function)for(;d--;){var e=a[d];if(this._events[e]instanceof Array){var b=this._events[e].indexOf(c);-1!==b&&this._events[e].splice(b,1);this._.removeEventListener(e,c)}}else for(;d--;)if(e=a[d],this._events[e]instanceof Array)for(;b=this._events[e].pop();)this._.removeEventListener(e,b);return this};c.prototype.one=function(a,c){var d=
this;return this.on(a,function b(){d.off(a,b);c.apply(this,[].slice.apply(arguments))})};c.prototype.append=function(a){for(var f=a instanceof Array?a:arguments,d=0,e=f.length;d<e;d++)this._.appendChild(f[d]instanceof c?f[d]._:f[d]);return this};c.prototype.replaceWith=function(a){a=a instanceof c?a._:a;this._.parentNode&&this._.parentNode.replaceChild(a,this._);this._=a;return this};c.prototype.text=function(a,c){var d=this.textWrap||this._;if(0===arguments.length)return d.textContent;d.textContent=
(c?d.textContent:"")+a;return this};c.prototype.html=function(a,c){this._.innerHTML=(c?this._.innerHTML:"")+a;return this};c.prototype.attr=function(a,c){if("string"!==typeof a)throw Error("An attribute name is required");if(void 0===c)return this._.getAttribute(a);this._.setAttribute(a,c);return this};c.prototype.remove=function(){if(this._.parentNode)return this._.parentNode.removeChild(this._),this};c.prototype.offset=function(a,c){this._.style.top=a;this._.style.left=c;return this};c.prototype.css=
function(a,c){if("string"===typeof a)if("string"===typeof c)this._.style[a]=c;else return getComputedStyle(this._)[a];else if(a instanceof Object)for(var d in a)this._.style[d]=a[d];return this};c.prototype.trigger=function(a){a=new Event(a);this._.dispatchEvent(a);return this};c.prototype.prev=function(){if(this._.previousSibling)return new c(this._.previousSibling)};c.prototype.next=function(){if(this._.nextSibling)return new c(this._.nextSibling)};c.prototype.data=function(a,c){this._data instanceof
Object||(this._data={});if(void 0===c)return this._data[a];this._data[a]=c;return this};return function(a,f){if(a instanceof c)return a;var d=new c;if("string"===typeof a){if(d._=document.createElement(a),"object"===typeof f){var e=Object.create(f);"string"===typeof e.textWrap&&(d.textWrap=document.createElement(e.textWrap),d._.appendChild(d.textWrap),e.textWrap=null);void 0!==e.text&&null!==f.text&&(d.text(e.text),e.text=null);"string"===typeof e.html&&(d.html(e.html),e.html=null);"string"===typeof e.class&&
(d.addClass(e.class),e.class=null);for(var b in e)e[b]&&d._.setAttribute(b,e[b])}}else d._=a;return d}}()},{}],8:[function(k,g,l){(function(c){(function(a){"object"===typeof l&&"undefined"!==typeof g?g.exports=a():("undefined"!==typeof window?window:"undefined"!==typeof c?c:"undefined"!==typeof self?self:this).EventEmitter=a()})(function(){return function f(c,e,b){function g(l,t){if(!e[l]){if(!c[l]){var q="function"==typeof k&&k;if(!t&&q)return q(l,!0);if(h)return h(l,!0);q=Error("Cannot find module '"+
l+"'");throw q.code="MODULE_NOT_FOUND",q;}q=e[l]={exports:{}};c[l][0].call(q.exports,function(b){var e=c[l][1][b];return g(e?e:b)},q,q.exports,f,c,e,b)}return e[l].exports}for(var h="function"==typeof k&&k,l=0;l<b.length;l++)g(b[l]);return g}({1:[function(c,d,e){d.exports=function(){function b(){this._events={}}b.prototype.on=function(b,c){this._events instanceof Object||(this._events={});this._events[b]instanceof Array||(this._events[b]=[]);this._events[b].push(c);return this};b.prototype.off=function(b,
c){this._events instanceof Object||(this._events={});if(!(this._events[b]instanceof Array))return!1;var d=this._events[b];d.splice(d.indexOf(c),1);return this};b.prototype.emit=function(b){this._events instanceof Object||(this._events={});if(!(this._events[b]instanceof Array))return!1;var c=[].slice.apply(arguments,[1]);this._events[b].forEach(function(b){b instanceof Function&&b.apply(null,c)})};return b}()},{}]},{},[1])(1)})}).call(this,"undefined"!==typeof global?global:"undefined"!==typeof self?
self:"undefined"!==typeof window?window:{})},{}]},{},[4])(4)});
